# LXC Configuration Template for K3s Nodes
#
# Append these lines to /etc/pve/lxc/<VMID>.conf on Proxmox host
# after creating the container with: pct create <VMID> ... --features nesting=1,keyctl=1,fuse=1
#
# Usage:
#   cat infrastructure/k3s/lxc-k3s-config.conf >> /etc/pve/lxc/100.conf
#
# These settings are REQUIRED for K3s to run in an unprivileged LXC container.
# Without them, kubelet will fail with permission errors.

# Mount /dev/kmsg for kubelet logging (required)
# Without this: "failed to create kubelet: open /dev/kmsg: operation not permitted"
lxc.mount.entry: /dev/kmsg dev/kmsg none bind,rw,optional,create=file

# Disable AppArmor restrictions (required for K3s system calls)
# K3s needs unrestricted access to perform container operations
lxc.apparmor.profile: unconfined

# Don't drop any capabilities (required for K3s)
# Empty value means all capabilities are retained
# K3s needs CAP_SYS_ADMIN, CAP_NET_ADMIN, etc.
lxc.cap.drop:

# Allow all devices (required for container runtime)
# K3s containerd needs access to create device nodes
lxc.cgroup2.devices.allow: a

# Mount /proc and /sys as read-write (required for sysctl operations)
# K3s needs to set kernel parameters like net.netfilter.nf_conntrack_max
lxc.mount.auto: proc:rw sys:rw

# Note: The following features must be set during container creation:
#   --features nesting=1,keyctl=1,fuse=1
#
# - nesting=1  : Required for running containers inside the LXC
# - keyctl=1   : Required for Kubernetes secrets
# - fuse=1     : Required for container filesystem operations
