# Nginx Reverse Proxy Configuration
# Namespace: dev
#
# Story: 7.1 - Deploy Nginx Reverse Proxy
# Story: 11.4 - Configure Nginx SSH Proxy with Custom Domains
# FR: FR41 - Configure Nginx to proxy to local dev servers
# FR: FR59 - Nginx proxy routes to dev containers
# FR: FR61 - Connect VS Code via Nginx proxy
#
# Purpose: ConfigMap-based nginx configuration for hot-reload capability (Story 7.3)
# Includes TCP stream module for SSH proxying to dev containers (Story 11.4)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-proxy-config
  namespace: dev
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/instance: nginx-proxy
    app.kubernetes.io/component: reverse-proxy
    app.kubernetes.io/part-of: home-lab
    app.kubernetes.io/managed-by: kubectl
data:
  nginx.conf: |
    # Nginx Reverse Proxy Configuration
    # Generated for Story 7.1 - Deploy Nginx Reverse Proxy
    # Updated for Story 11.4 - SSH Proxy to Dev Containers
    # Note: Stream module is compiled-in with nginx:alpine (--with-stream)

    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  1024;
    }

    # TCP Stream configuration for SSH proxying to dev containers
    # Story 11.4: Configure Nginx SSH Proxy with Custom Domains
    stream {
        # Use Kubernetes CoreDNS IP for dynamic resolution
        resolver 10.43.0.10 valid=30s ipv6=off;
        resolver_timeout 5s;

        # Use map to assign backend to variable (forces runtime DNS resolution)
        map $server_port $ssh_backend {
            2222 dev-container-calsync-svc.dev.svc.cluster.local:22;
            2223 dev-container-pilates-svc.dev.svc.cluster.local:22;
            2224 dev-container-ai-dev-svc.dev.svc.cluster.local:22;
        }

        # SSH proxy for CalSync on port 2222
        server {
            listen 2222;
            proxy_pass $ssh_backend;
            proxy_connect_timeout 10s;
            proxy_timeout 300s;
        }

        # SSH proxy for Pilates on port 2223
        server {
            listen 2223;
            proxy_pass $ssh_backend;
            proxy_connect_timeout 10s;
            proxy_timeout 300s;
        }

        # SSH proxy for AI-Dev on port 2224
        server {
            listen 2224;
            proxy_pass $ssh_backend;
            proxy_connect_timeout 10s;
            proxy_timeout 300s;
        }
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        keepalive_timeout  65;

        # Upstream definitions for dev servers
        # Story 7.2: Configure Ingress for Dev Proxy Access
        upstream app1 {
            server 192.168.2.50:3000;
        }

        upstream app2 {
            server 192.168.2.51:8080;
        }

        # Proxy for dev.calsync.info to CalSync dev container port 3000
        server {
            listen 80;
            server_name dev.calsync.info;

            # Use Kubernetes CoreDNS for runtime DNS resolution
            resolver 10.43.0.10 valid=30s ipv6=off;
            resolver_timeout 5s;

            # Disable all caching for dev server
            proxy_buffering off;
            proxy_cache off;

            # Larger buffers for OAuth callbacks with big headers/cookies
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;

            location / {
                # Use variable to force runtime DNS resolution (not at config parse time)
                set $backend "dev-container-calsync-svc.dev.svc.cluster.local:3000";
                proxy_pass http://$backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # No caching headers
                add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
                add_header Pragma "no-cache";
                add_header Expires "0";
            }
        }

        server {
            listen       80 default_server;
            server_name  localhost;

            # Default location - returns nginx welcome page
            location / {
                root   /usr/share/nginx/html;
                index  index.html index.htm;
            }

            # Proxy to app1 (dev server on 192.168.2.50:3000)
            location /app1 {
                proxy_pass http://app1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Proxy to app2 (dev server on 192.168.2.51:8080)
            location /app2 {
                proxy_pass http://app2;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # Error pages
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   /usr/share/nginx/html;
            }
        }
    }
