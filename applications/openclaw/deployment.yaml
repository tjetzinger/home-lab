---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
  namespace: apps
  labels:
    app.kubernetes.io/name: openclaw
    app.kubernetes.io/part-of: home-lab
    app.kubernetes.io/managed-by: kubectl
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: openclaw
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openclaw
        app.kubernetes.io/part-of: home-lab
    spec:
      # Pin to k3s-worker-01 for local storage persistence
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - k3s-worker-01
      initContainers:
        - name: fix-permissions
          image: busybox:1.37
          command: ["sh", "-c", "chown -R 1000:1000 /data/openclaw /data/clawd 2>/dev/null; mkdir -p /data/openclaw/memory/lancedb && chown -R 1000:1000 /data/openclaw/memory"]
          volumeMounts:
            - name: openclaw-data
              mountPath: /data/openclaw
              subPath: openclaw
            - name: openclaw-data
              mountPath: /data/clawd
              subPath: clawd
          securityContext:
            runAsUser: 0
      containers:
        - name: openclaw
          image: docker.io/library/openclaw:2026.1.29
          imagePullPolicy: Never
          command:
            - node
            - dist/entry.js
            - gateway
            - --bind
            - lan
            - --port
            - "18789"
            - --allow-unconfigured
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
            - name: bridge
              containerPort: 18790
              protocol: TCP
          envFrom:
            - secretRef:
                name: openclaw-secrets
          volumeMounts:
            - name: openclaw-data
              mountPath: /home/node/.openclaw
              subPath: openclaw
            - name: openclaw-data
              mountPath: /home/node/clawd
              subPath: clawd
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
      volumes:
        - name: openclaw-data
          persistentVolumeClaim:
            claimName: openclaw-data
